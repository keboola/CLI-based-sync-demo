name: Manual Storage Diff All
on:
  workflow_dispatch:
    inputs:
      dest_env:
        description: 'Which environment to compare against (will be destination)'
        required: true
        default: ''
permissions:
  contents: write
jobs:
  get_current_branch_env:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - environment: |-
              ${{
                 github.ref_name == 'main' && 'prod'
              || github.ref_name == 'dev' && 'dev'
              }}
            origin: "source"
          - environment: ${{ github.event.inputs.dest_env }}
            origin: "destination"
    environment: ${{ matrix.environment }}
    env:
      outFolder: "projects_structure_${{ matrix.origin }}"
    steps:
      - uses: actions/checkout@v4
      # L0
      - name: Pull storage L0
        uses: ./.github/actions/kbc_storage_validation/pull
        with:
          outFolder: "${{ env.outFolder }}"
          destFile: "${{ matrix.origin }}/${{ matrix.environment }}/L0.json"
          kbcStorageApiHost: ${{ vars.KBC_STORAGE_API_HOST_L0 }}
          kbcStorageApiToken: ${{ secrets.KBC_STORAGE_API_TOKEN_L0 }}

      # L1
      - name: Pull storage L1
        uses: ./.github/actions/kbc_storage_validation/pull
        with:
          outFolder: "${{ env.outFolder }}"
          destFile: "${{ matrix.origin }}/${{ matrix.environment }}/L1.json"
          kbcStorageApiHost: ${{ vars.KBC_STORAGE_API_HOST_L1 }}
          kbcStorageApiToken: ${{ secrets.KBC_STORAGE_API_TOKEN_L1 }}

  compare_storage:
    runs-on: ubuntu-latest
    needs: get_current_branch_env
    steps:
      - uses: actions/checkout@v4
      - name: Download structures
        uses: actions/download-artifact@v4
        with:
          name: |
            projects_structure_source
            projects_structure_destination
      - run: |
          ls -l
